# TD4 
「CPUの創りかた」の4bitCPU「TD4」をFPGAで作成  
  
*使用ボード：BASYS2 (Xilinx)  
*ツール：ISE Profect Navigator 14.7  
*シミュレーション：ISim  
*言語：VHDL  


ROM
  TD4のROMは16byteあり、あらかじめプログラムをROMに格納してから実行します。
  実際のTD4は16個のディップスイッチを用いていますが、FPGAボードを用いた場合はROMのコードに直接プログラムを打ち込んでいます。

  TD4で用いるプログラムは各8bitです。
  ROMは16byteなので全部で16ステップのプログラムを格納できます。
  プログラムカウンタからプログラムが格納されているアドレスを指定する4bitの信号が送られ、対応するプログラム8bitを出力します。

  8bitのプログラムのうち上位4bitは命令の機能である「オペレーションコード」であり、デコーダに出力されます。
  下位4bitは命令に組み込まれたデータであり、「イミディエイトデータ」と呼ばれます。こちらはALUに出力されます。
  
レジスタ
  TD4のレジスタは4種類あり、本書内ではフリップフロップで実現しています。
  デコーダから入力されるLoad信号で4つあるレジスタのうち1つを更新し、残りの3つは値を保持します。
  各レジスタにはタイミング制御のためのクロックとリセット信号を入力します。

  AレジスタとBレジスタはデータセレクタに4bitの信号を送信します。
  CレジスタはLEDへの出力ポートとして使い、最後のDレジスタはROMのアドレスを指定するプログラムカウンタとして使用します。
  プログラムカウンタはクロック信号が入るたびに＋1して次のROMアドレスを指定できるようにしています。
  
データセレクタ
  データセレクタは4入力（Aレジスタ、Bレジスタ、スイッチ入力、"0000"）のうちから1つを選び、ALUに出力します。
  この選択にはデコーダから入力される2bitのセレクト信号を利用します。
  
ALUの作成
  TD4のALUは全加算器が4個、キャリーフラグ用にフリップフロップを1個使用しています。
  データセレクタとROMから送られる4bitの入力を加算し、A～Dレジスタに出力します。
  繰り上がりが発生した場合はキャリーフラグに'1'を出力しますが、これを分岐命令に利用します。

  ALUは階層設計で作成します。
  まず1個の全加算器のコードが以下です。
  
  全加算器4個とキャリーフラグを組み合わせた上位モジュールのコードがALU.
  
  
デコーダ
  デコーダはROMに格納されている命令を指示に変換する回路です。
  全部で13ある命令それぞれについて、対応するオペレーションコードや加算器のキャリーフラグを入力とし、データセレクタのセレクト信号やレジスタのLoad信号を出力します。
  「CPUの創りかた」ではOR回路4個と3入力NAND回路3個で実現しています。

  FPGAで作成するにあたって、入出力の真理値表を元にそのままコード化しました。
  回路規模は大きくなってしまいますが、コードの可読性は良くなるので忘れたころに見返しても理解しやすいですし、拡張などもしやすいです。
  各命令の処理は入出力の真理値表を元にwhen文を使って場合分けしています。
  
  
クロック
  「CPUの創りかた」では押しボタンによるクロック、発振回路を用いた1Hzと10Hzのクロックの3種類のクロックがあります。
  今回は動作の確認がしやすいように押しボタンによるクロックのみ搭載することにしました。

  ここで問題になるのが押しボタンのチャタリング対策です。
  本物のTD4では抵抗とコンデンサを使ったローパスフィルタ回路とシュミッドトリガで対応しています。
  FPGAボードを使用する場合はアナログ回路をいじるのが面倒なのでソフトウェアでチャタリング対策をしました。

  ボタンを押すと最初チャタリングが発生してオンとオフが連続的に出力されますが、その後チャタリングが収まればオン状態のままになります。
  オン状態のままでクロックを一定回数カウントしたらパルスを1回出力するという回路を作成します。
  ここで出力されたパルスをクロック信号として他の部品に供給します。

  Basys2は元々100MHzのクロックがあり、クロックのパルス幅は10nsです。
  人がボタンを一回押して離した場合、どんなに素早くオンオフしても、たいてい数百μs程度の時間は押してしまいます。
  そこで100μsの時間クロック信号が入力されたら1パルスを出力する回路を作成しました。
  1クロックで10nsなので、100μs / 10ns = 10000より1万カウントしたらパルスを出力します。
